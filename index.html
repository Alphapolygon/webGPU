<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Illegal Mexican Cockfight 2</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no" />
  <meta name="theme-color" content="#000000" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">

  <!-- (Optional) Preload build files for a snappier start -->
  <link rel="preload" href="Build/export.data.unityweb" as="fetch" crossorigin>
  <link rel="preload" href="Build/export.wasm.unityweb" as="fetch" crossorigin>
  <link rel="preload" href="Build/export.framework.js.unityweb" as="fetch" crossorigin>

  <style>
    :root { --bg:#000; --fg:#e6e6e6; --muted:#adadad; }
    html, body {
      margin:0; padding:0; width:100%; height:100%; background:var(--bg);
      overscroll-behavior:none; touch-action:none;
    }

    /* ===== Unity container ===== */
    #unity-container{
      position:fixed; inset:0;
      padding-top:env(safe-area-inset-top);
      padding-right:env(safe-area-inset-right);
      padding-bottom:env(safe-area-inset-bottom);
      padding-left:env(safe-area-inset-left);
      width:100vw; height:100dvh; display:grid;
    }
    #unity-canvas{ width:100%; height:100%; display:block; background:var(--bg); }

    /* ===== Custom Loader ===== */
    #loader {
      position: fixed; inset: 0; display: grid; place-items: center;
      background: #0b0b0b; color: var(--fg); z-index: 10000;
      transition: opacity .4s ease;
    }
    #loader.hidden { opacity: 0; pointer-events: none; }

    .loader-card {
      width: min(520px, 90vw);
      display: grid; gap: 16px; text-align: center;
      padding: 28px 24px; border-radius: 20px;
      background: linear-gradient(180deg, #121212, #0d0d0d);
      box-shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
    }
    .brand { display:grid; gap:8px; place-items:center; }
    .brand svg { width:56px; height:56px; }
    .title { font: 600 18px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .subtitle { font: 500 13px/1.3 system-ui; color: var(--muted); min-height: 1.3em; }

    .bar { position:relative; height:12px; border-radius:999px; overflow:hidden; background: rgba(255,255,255,.06); }
    .fill { width:100%; height:100%; transform-origin:left center; transform:scaleX(0);
      background: linear-gradient(90deg, #6ee7ff, #a78bfa, #60a5fa); filter:saturate(1.1); }

    .nums { display:flex; justify-content:space-between; font:600 12px/1 system-ui; color:#cfcfcf; opacity:.9; }
    .tips { font:12px/1.35 system-ui; color:#9d9d9d; min-height:2.7em; }
    .spinner { width:18px; height:18px; margin:0 auto; border-radius:50%;
      border:2px solid rgba(255,255,255,.15); border-top-color: rgba(255,255,255,.65);
      animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @media (prefers-reduced-motion: reduce) {
      .spinner { animation:none; }
      #loader { transition:none; }
    }

    /* ===== Rotate overlay (mobile portrait) ===== */
    #rotate-overlay{
      position: fixed; inset: 0; display:none; place-items:center; text-align:center;
      background: rgba(0,0,0,.9); color:#fff; z-index: 9999; padding: 24px;
      font: 600 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    body[data-mobile="1"] @media (orientation: portrait){
      #rotate-overlay{ display:grid; }
    }

    /* ===== Offline banner ===== */
    #net{ position:fixed; left:0; right:0; bottom:0; background:#e00; color:#fff;
      text-align:center; padding:8px; display:none; z-index:9999; font: 600 12px system-ui; }
  </style>
</head>
<body>
  <!-- Loader -->
  <div id="loader" role="status" aria-live="polite">
    <div class="loader-card">
      <div class="brand">
        <!-- Replace with your logo if desired -->
        <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 2l8 5v10l-8 5-8-5V7l8-5zm0 2.3L6 7v8l6 3.7L18 15V7l-6-2.7z"/></svg>
        <div class="title">Loading Illegal Mexican Cockfight 2</div>
      </div>
      <div class="subtitle" id="load-status">Preparing…</div>
      <div class="bar" aria-hidden="true"><div class="fill" id="load-fill"></div></div>
      <div class="nums">
        <div id="load-percent">0%</div>
        <div id="load-eta">ETA —</div>
      </div>
      <div class="tips" id="load-tip">Tip: On mobile, first tap enters fullscreen.</div>
      <div class="spinner" aria-hidden="true"></div>
    </div>
  </div>

  <!-- Portrait warning (shown only on mobile via CSS+JS) -->
  <div id="rotate-overlay">Please rotate your device to landscape</div>

  <!-- Offline banner -->
  <div id="net">You’re offline</div>

  <!-- Unity container/canvas -->
  <div id="unity-container">
    <canvas id="unity-canvas" tabindex="-1"></canvas>
  </div>

  <script>
    // ------- Environment detection -------
    const ua = navigator.userAgent || "";
    const isIOS = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);
    const isAndroid = /Android/i.test(ua);
    const isMobile = isIOS || isAndroid;
    document.body.dataset.mobile = isMobile ? "1" : "0";

    // Friendly heads-up if WebGPU is missing (does not block load)
    if (!('gpu' in navigator)) {
      console.log("WebGPU not detected; this build may require WebGPU-capable browsers.");
    }

    // Keep container matching viewport (fallback for older browsers)
    function fit(){
      const cont = document.getElementById('unity-container');
      cont.style.width = window.innerWidth + 'px';
      cont.style.height = window.innerHeight + 'px';
    }
    addEventListener('resize', fit, {passive:true}); fit();

    // Offline/online banner
    const net = document.getElementById('net');
    function syncNet(){ net.style.display = navigator.onLine ? 'none' : 'block'; }
    addEventListener('online', syncNet); addEventListener('offline', syncNet); syncNet();

    // Wake Lock (keep screen on) after first interaction
    async function keepAwake(){ try{ await navigator.wakeLock?.request('screen'); }catch(e){} }
    addEventListener('pointerdown', keepAwake, { once:true });

    // Audio unlock (WebAudio resumes on gesture)
    let audioCtx;
    function unlockAudio(){
      audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
      audioCtx.resume?.();
      removeEventListener('pointerdown', unlockAudio);
      removeEventListener('touchstart', unlockAudio);
    }
    addEventListener('pointerdown', unlockAudio);
    addEventListener('touchstart', unlockAudio, { passive:true });

    // Pointer lock on desktop when clicking canvas (good for FPS)
    const canvasEl = document.getElementById('unity-canvas');
    canvasEl.addEventListener('click', ()=>{ if (!document.pointerLockElement) canvasEl.requestPointerLock?.(); });

    // ------- Unity bootstrap -------
    const buildUrl = "Build";
    const loaderUrl = buildUrl + "/export.loader.js";
    const config = {
      dataUrl: buildUrl + "/export.data.unityweb",
      frameworkUrl: buildUrl + "/export.framework.js.unityweb",
      codeUrl: buildUrl + "/export.wasm.unityweb",
      streamingAssetsUrl: "StreamingAssets",
      companyName: "alphapolygon",
      productName: "webGPU",
      productVersion: "0.1.0",
      devicePixelRatio: (isMobile ? 1 : (window.devicePixelRatio || 1))
    };

    // Loader UI logic (progress smoothing, ETA, rotating tips)
    const loaderEl = document.getElementById('loader');
    const fillEl = document.getElementById('load-fill');
    const pctEl  = document.getElementById('load-percent');
    const etaEl  = document.getElementById('load-eta');
    const statusEl = document.getElementById('load-status');
    const tipEl = document.getElementById('load-tip');

    const TIPS = [
      "Tip: Rotate your device for landscape play.",
      "Tip: Connect a gamepad for dual-stick controls.",
      "Tip: Close other tabs to free up GPU memory.",
      "Tip: First tap enables audio and fullscreen.",
      "Tip: Use wired keyboards on mobile with adapters."
    ];
    function prettyETA(seconds){
      if (!isFinite(seconds) || seconds <= 0) return "—";
      const m = Math.floor(seconds/60), s = Math.max(0, Math.round(seconds%60));
      return m ? `${m}m ${s}s` : `${s}s`;
    }

    let t0 = performance.now();
    let displayed = 0, target = 0, emaRate = 0, lastT = t0, lastTarget = 0;
    let tipIdx = 0, nextTipAt = t0 + 5000;

    function step(){
      const now = performance.now();
      displayed += (target - displayed) * 0.12;
      displayed = Math.min(0.999, Math.max(0, displayed));
      fillEl.style.transform = `scaleX(${displayed})`;
      const pct = Math.max(0, Math.min(100, Math.round(displayed * 100)));
      pctEl.textContent = pct + "%";

      if (target < 0.05) statusEl.textContent = "Preparing…";
      else if (target < 0.75) statusEl.textContent = "Downloading game data…";
      else if (target < 0.95) statusEl.textContent = "Initializing…";
      else statusEl.textContent = "Almost there…";

      const dt = (now - lastT) / 1000;
      const dp = Math.max(0, target - lastTarget);
      const instRate = dt > 0 ? dp / dt : 0;
      emaRate = emaRate ? (emaRate * 0.9 + instRate * 0.1) : instRate;
      const remaining = Math.max(0.0001, 1 - displayed);
      const eta = emaRate > 0 ? (remaining / emaRate) : Infinity;
      etaEl.textContent = "ETA " + prettyETA(eta);

      if (now >= nextTipAt) {
        tipIdx = (tipIdx + 1) % TIPS.length;
        tipEl.textContent = TIPS[tipIdx];
        nextTipAt = now + 7000;
      }

      requestAnimationFrame(step);
      lastT = now; lastTarget = target;
    }
    requestAnimationFrame(step);

    // Fullscreen + Landscape lock after first gesture
    function goInteractive(){
      const elem = document.documentElement; // or canvas/container
      const reqFS = elem.requestFullscreen?.bind(elem) || elem.webkitRequestFullscreen?.bind(elem);
      if (reqFS) { reqFS().catch(()=>{}); }

      try { if (typeof unityInstance !== 'undefined') unityInstance.SetFullscreen(1); } catch(e){}

      (async ()=>{
        // Orientation lock requires user gesture and often fullscreen
        if (screen.orientation?.lock) {
          try { await screen.orientation.lock('landscape'); }
          catch(e){ console.warn('Orientation lock failed:', e); }
        }
      })();

      removeEventListener('pointerdown', goInteractive);
      removeEventListener('touchstart', goInteractive);
    }
    addEventListener('pointerdown', goInteractive, { once:true });
    addEventListener('touchstart', goInteractive, { once:true, passive:true });

    // Load Unity
    let unityInstance; // for SetFullscreen attempt above
    const script = document.createElement("script");
    script.src = loaderUrl;
    script.onload = () => {
      createUnityInstance(canvasEl, config, (p) => {
        target = Math.min(1, Math.max(0, p));
      }).then((inst) => {
        unityInstance = inst;
        // Give Unity a brief moment to render first frame, then hide loader
        setTimeout(() => {
          loaderEl.classList.add('hidden');
          setTimeout(() => loaderEl.remove(), 500);
        }, 150);
      }).catch((msg) => {
        statusEl.textContent = "Load failed";
        tipEl.textContent = String(msg || "Check your network and reload.");
        console.error(msg);
      });
    };
    document.body.appendChild(script);

    // Register service worker (PWA/offline)
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js').catch(()=>{});
    }
  </script>
</body>
</html>
